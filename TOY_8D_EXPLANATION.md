# Toy 8D 问题详细说明

## 1. 数据结构

### 8D真实数据 (x0)
- **维度**: 8维向量 `[x0, x1, x2, x3, x4, x5, x6, x7]`
- **来源**: 从先验分布（Prior）采样得到
- **图像映射**: 被reshape成1x4x4图像的前8个位置

### 图像格式 (1x4x4 = 16维)
```
1x4x4图像布局:
┌─────────────────┐
│ x0  x1  x2  x3  │  ← 前4个位置 (第0-3维)
│ x4  x5  x6  x7  │  ← 接下来4个位置 (第4-7维)
│  0   0   0   0  │  ← 零填充 (第8-11维)
│  0   0   0   0  │  ← 零填充 (第12-15维)
└─────────────────┘
```

**重要**: 只有前8个位置包含真实数据，后8个位置应该是0（零填充）

---

## 2. A矩阵 (Forward Operator)

### 定义
- **形状**: 8×8 的随机高斯矩阵
- **作用**: 将8D数据映射到8D观测空间
- **公式**: `y_8d = A @ x0_8d + noise`

### 在代码中
```python
# A只作用于前8维
A_8x8 = torch.randn(8, 8) * A_scale  # 8x8矩阵
# 被padding成16x16（后8行8列都是0）
A_16x16 = F.pad(A_8x8, (0, 8, 0, 8), "constant", 0)
```

### 物理意义
- A是线性逆问题的前向算子
- 模拟测量过程（如传感器测量、投影等）
- 将未知参数x0转换为可观测的测量值y

---

## 3. Observation (观测值 y)

### 生成过程
```python
# 1. 从先验采样真实值
x0_8d = sample_prior()  # [8]

# 2. 通过A矩阵生成观测
y_8d = A @ x0_8d + noise  # [8]
# noise ~ N(0, noise_std^2), noise_std = 0.2236

# 3. 零填充并reshape成图像
y_16d = pad(y_8d, zeros)  # [16]
y_img = reshape(y_16d, [1, 4, 4])  # [1, 4, 4]
```

### 在可视化图中
- **Observation图**: 显示观测到的数据（带噪声）
- 由于A的作用和噪声，observation可能与target不同
- 但通常应该相似（因为A是线性变换）

---

## 4. Prior (先验分布)

### 类型: 混合高斯分布 (Mixture of 2 Gaussians)

#### 两个分量:
1. **分量1** (权重50%):
   - 均值: `[0, 0, 0, 0, 0, 0, 0, -2.0]`
   - 第8维（最后一个维度）为 -2.0

2. **分量2** (权重50%):
   - 均值: `[0, 0, 0, 0, 0, 0, 0, +2.0]`
   - 第8维（最后一个维度）为 +2.0

#### 协方差矩阵:
- **结构**: 指数衰减
- **公式**: `Sigma[i,j] = rho^|i-j|`, 其中 `rho = 0.8`
- **特点**: 相邻维度相关性高，距离越远相关性越低

#### 采样过程:
```python
# 1. 随机选择分量
comp = multinomial(weights)  # 50%概率选分量1或2

# 2. 从选中的分量采样
z ~ N(0, Sigma)  # 从协方差矩阵采样
x0_8d = means[comp] + z  # 加上均值
```

### 先验的特点
- **双峰分布**: 第8维倾向于在-2或+2附近
- **相关性**: 8个维度之间有相关性（rho=0.8）
- **其他维度**: 前7维的均值都是0，但有方差

---

## 5. 8D数据在可视化图中的映射

### 图像布局
```
可视化图是4x4的网格，对应16维数据:

位置映射:
┌─────────────────────────┐
│ [0]  [1]  [2]  [3]      │  ← 前4维 (x0-x3)
│ [4]  [5]  [6]  [7]      │  ← 接下来4维 (x4-x7) 
│ [8]  [9]  [10] [11]     │  ← 零填充 (应该是0)
│ [12] [13] [14] [15]     │  ← 零填充 (应该是0)
└─────────────────────────┘
```

### 在可视化中
- **Target图**: 显示真实的8D数据（前8个位置）+ 零填充（后8个位置）
- **Reconstruction图**: 显示算法重建的结果
- **Observation图**: 显示观测到的数据

### 如何解读
- **前两行** (位置0-7): 包含真实的8D数据
- **后两行** (位置8-15): 应该是0（零填充）
- 如果reconstruction的后两行不是0，说明算法没有正确学习到零填充结构

---

## 6. 逆问题的目标

### 问题定义
给定观测 `y`，重建真实的 `x0`:
```
已知: y = A @ x0 + noise
求解: x0 = ?
```

### 挑战
- A矩阵可能不是满秩（信息丢失）
- 噪声使得问题不确定
- 需要利用先验知识（prior）来约束解

### DPS算法的作用
- 使用扩散模型作为先验
- 通过数据拟合项（guidance）来约束解满足观测
- 平衡先验项和数据拟合项

---

## 7. 当前问题分析

从可视化图可以看出：
- **Target**: 前两行有值，后两行是0（正确）
- **Reconstruction**: 所有位置都有值，且数值范围很大（-100到150）
- **问题**: 重建结果没有保持零填充结构，且数值不稳定

**可能原因**:
1. guidance_scale太小，数据拟合项太弱
2. 模型没有学习到零填充结构
3. 数值稳定性问题

